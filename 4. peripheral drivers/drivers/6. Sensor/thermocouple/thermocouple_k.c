#include <stdint.h>

#include "thermocouple_k.h"
#include <math.h>

#define THERMOCOUPLE_BASE           (-200.0f)
#define THERMOCOUPLE_TAB_SIZE       (601UL)

/**
 * K型热电偶分度表（-200℃ ~ 400℃）
 * 严格遵循ITS-90标准文档格式
 * 数组索引0对应-200℃，索引600对应400℃
 * 单位：毫伏（mV）
 * 参考端温度：0℃
 */
const float k_type_thermocouple_table[] = {
    -5.891,
    -5.876, -5.861, -5.845, -5.829, -5.813, -5.797, -5.780, -5.763, -5.747, -5.730, // -199℃~-190℃
    -5.713, -5.695, -5.678, -5.660, -5.642, -5.624, -5.606, -5.588, -5.569, -5.550, // -189℃~-180℃
    -5.531, -5.512, -5.493, -5.474, -5.454, -5.435, -5.415, -5.395, -5.374, -5.354, // -179℃~-170℃
    -5.333, -5.313, -5.292, -5.271, -5.250, -5.228, -5.207, -5.185, -5.163, -5.141, // -169℃~-160℃
    -5.119, -5.097, -5.074, -5.052, -5.029, -5.006, -4.983, -4.960, -4.936, -4.913, // -159℃~-150℃
    -4.889, -4.865, -4.841, -4.817, -4.793, -4.768, -4.744, -4.719, -4.694, -4.669, // -149℃~-140℃
    -4.644, -4.618, -4.593, -4.567, -4.542, -4.516, -4.490, -4.463, -4.437, -4.411, // -139℃~-130℃
    -4.384, -4.357, -4.330, -4.303, -4.276, -4.249, -4.221, -4.194, -4.166, -4.138, // -129℃~-120℃
    -4.110, -4.082, -4.054, -4.025, -3.997, -3.968, -3.939, -3.911, -3.882, -3.852, // -119℃~-110℃
    -3.823, -3.794, -3.764, -3.734, -3.705, -3.675, -3.645, -3.614, -3.584, -3.554, // -109℃~-100℃
    -3.523, -3.492, -3.462, -3.431, -3.400, -3.368, -3.337, -3.306, -3.274, -3.243, // -99℃~-90℃
    -3.211, -3.179, -3.147, -3.115, -3.083, -3.050, -3.018, -2.986, -2.953, -2.920, // -89℃~-80℃
    -2.887, -2.854, -2.821, -2.788, -2.755, -2.721, -2.688, -2.654, -2.620, -2.587, // -79℃~-70℃
    -2.553, -2.519, -2.485, -2.450, -2.416, -2.382, -2.347, -2.312, -2.278, -2.243, // -69℃~-60℃
    -2.208, -2.173, -2.138, -2.103, -2.067, -2.032, -1.996, -1.961, -1.925, -1.889, // -59℃~-50℃
    -1.854, -1.818, -1.782, -1.745, -1.709, -1.673, -1.637, -1.600, -1.564, -1.527, // -49℃~-40℃
    -1.490, -1.453, -1.417, -1.380, -1.343, -1.305, -1.268, -1.231, -1.194, -1.156, // -39℃~-30℃
    -1.119, -1.081, -1.043, -1.006, -0.968, -0.930, -0.892, -0.854, -0.816, -0.778, // -29℃~-20℃
    -0.739, -0.701, -0.663, -0.624, -0.586, -0.547, -0.508, -0.470, -0.431, -0.392, // -19℃~-10℃
    -0.353, -0.314, -0.275, -0.236, -0.197, -0.157, -0.118, -0.079, -0.039, 0.000, // -9℃~0℃ (索引200)
    0.039, 0.079, 0.119, 0.158, 0.198, 0.238, 0.277, 0.317, 0.357, // 1℃~9℃
    0.397, 0.437, 0.477, 0.517, 0.557, 0.597, 0.637, 0.677, 0.718, 0.758, // 10℃~19℃
    0.798, 0.838, 0.879, 0.919, 0.960, 1.000, 1.041, 1.081, 1.122, 1.163, // 20℃~29℃
    1.203, 1.244, 1.285, 1.326, 1.366, 1.407, 1.448, 1.489, 1.530, 1.571, // 30℃~39℃
    1.612, 1.653, 1.694, 1.735, 1.776, 1.817, 1.858, 1.899, 1.941, 1.982, // 40℃~49℃
    2.023, 2.064, 2.106, 2.147, 2.188, 2.230, 2.271, 2.312, 2.354, 2.395, // 50℃~59℃
    2.436, 2.478, 2.519, 2.561, 2.602, 2.644, 2.685, 2.727, 2.768, 2.810, // 60℃~69℃
    2.851, 2.893, 2.934, 2.976, 3.017, 3.059, 3.100, 3.142, 3.184, 3.225, // 70℃~79℃
    3.267, 3.308, 3.350, 3.391, 3.433, 3.474, 3.516, 3.557, 3.599, 3.640, // 80℃~89℃
    3.682, 3.723, 3.765, 3.806, 3.848, 3.889, 3.931, 3.972, 4.013, 4.055, // 90℃~99℃
    4.096, 4.138, 4.179, 4.220, 4.262, 4.303, 4.344, 4.385, 4.427, 4.468, // 100℃~109℃
    4.509, 4.550, 4.591, 4.633, 4.674, 4.715, 4.756, 4.797, 4.838, 4.879, // 110℃~119℃
    4.920, 4.961, 5.002, 5.043, 5.084, 5.124, 5.165, 5.206, 5.247, 5.288, // 120℃~129℃
    5.328, 5.369, 5.410, 5.450, 5.491, 5.532, 5.572, 5.613, 5.653, 5.694, // 130℃~139℃
    5.735, 5.775, 5.815, 5.856, 5.896, 5.937, 5.977, 6.017, 6.058, 6.098, // 140℃~149℃
    6.138, 6.179, 6.219, 6.259, 6.299, 6.339, 6.380, 6.420, 6.460, 6.500, // 150℃~159℃
    6.540, 6.580, 6.620, 6.660, 6.701, 6.741, 6.781, 6.821, 6.861, 6.901, // 160℃~169℃
    6.941, 6.981, 7.021, 7.060, 7.100, 7.140, 7.180, 7.220, 7.260, 7.300, // 170℃~179℃
    7.340, 7.380, 7.420, 7.460, 7.500, 7.540, 7.579, 7.619, 7.659, 7.699, // 180℃~189℃
    7.739, 7.779, 7.819, 7.859, 7.899, 7.939, 7.979, 8.019, 8.059, 8.099, // 190℃~199℃
    8.138, 8.178, 8.218, 8.258, 8.298, 8.338, 8.378, 8.418, 8.458, 8.499, // 200℃~209℃
    8.539, 8.579, 8.619, 8.659, 8.699, 8.739, 8.779, 8.819, 8.860, 8.900, // 210℃~219℃
    8.940, 8.980, 9.020, 9.061, 9.101, 9.141, 9.181, 9.222, 9.262, 9.302, // 220℃~229℃
    9.343, 9.383, 9.423, 9.464, 9.504, 9.545, 9.585, 9.626, 9.666, 9.707, // 230℃~239℃
    9.747, 9.788, 9.828, 9.869, 9.909, 9.950, 9.991, 10.031, 10.072, 10.113, // 240℃~249℃
    10.153, 10.194, 10.235, 10.276, 10.316, 10.357, 10.398, 10.439, 10.480, 10.520, // 250℃~259℃
    10.561, 10.602, 10.643, 10.684, 10.725, 10.766, 10.807, 10.848, 10.889, 10.930, // 260℃~269℃
    10.971, 11.012, 11.053, 11.094, 11.135, 11.176, 11.217, 11.259, 11.300, 11.341, // 270℃~279℃
    11.382, 11.423, 11.465, 11.506, 11.547, 11.588, 11.630, 11.671, 11.712, 11.753, // 280℃~289℃
    11.795, 11.836, 11.877, 11.919, 11.960, 12.001, 12.043, 12.084, 12.126, 12.167, // 290℃~299℃
    12.209, 12.250, 12.291, 12.333, 12.374, 12.416, 12.457, 12.499, 12.540, 12.582, // 300℃~309℃
    12.624, 12.665, 12.707, 12.748, 12.790, 12.831, 12.873, 12.915, 12.956, 12.998, // 310℃~319℃
    13.040, 13.081, 13.123, 13.165, 13.206, 13.248, 13.290, 13.331, 13.373, 13.415, // 320℃~329℃
    13.457, 13.498, 13.540, 13.582, 13.624, 13.665, 13.707, 13.749, 13.791, 13.833, // 330℃~339℃
    13.874, 13.916, 13.958, 14.000, 14.042, 14.084, 14.126, 14.167, 14.209, 14.251, // 340℃~349℃
    14.293, 14.335, 14.377, 14.419, 14.461, 14.503, 14.545, 14.587, 14.629, 14.671, // 350℃~359℃
    14.713, 14.755, 14.797, 14.839, 14.881, 14.923, 14.965, 15.007, 15.049, 15.091, // 360℃~369℃
    15.133, 15.175, 15.217, 15.259, 15.301, 15.343, 15.385, 15.427, 15.469, 15.511, // 370℃~379℃
    15.554, 15.596, 15.638, 15.680, 15.722, 15.764, 15.806, 15.849, 15.891, 15.933, // 380℃~389℃
    15.975, 16.017, 16.059, 16.102, 16.144, 16.186, 16.228, 16.270, 16.313, 16.355, // 390℃~399℃
    16.397 // 400℃ (索引600)
};


#define K_N_C0 (0.00E+00)
#define K_N_C1 (3.95E-02)
#define K_N_C2 (2.36E-05)
#define K_N_C3 (-3.29E-07)
#define K_N_C4 (-4.99E-09)
#define K_N_C5 (-6.75E-11)
#define K_N_C6 (-5.74E-13)
#define K_N_C7 (-3.11E-15)
#define K_N_C8 (-1.05E-17)
#define K_N_C9 (-1.99E-20)
#define K_N_C10 (-1.63E-23)

static const double k_type_n_coeff_inv_table[] = {
    K_N_C0, K_N_C1, K_N_C2, K_N_C3, K_N_C4, K_N_C5, K_N_C6, K_N_C7, K_N_C8, K_N_C9, K_N_C10
};



#define K_P_C0 (-1.76E-02)
#define K_P_C1 (3.89E-02)
#define K_P_C2 (1.86E-05)
#define K_P_C3 (-9.95E-08)
#define K_P_C4 (3.18E-10)
#define K_P_C5 (-5.61E-13)
#define K_P_C6 (5.61E-16)
#define K_P_C7 (-3.20E-19)
#define K_P_C8 (9.72E-23)
#define K_P_C9 (-1.21E-26)

static const double k_type_p_coeff_inv_table[] = {
    K_P_C0, K_P_C1, K_P_C2, K_P_C3, K_P_C4, K_P_C5, K_P_C6, K_P_C7, K_P_C8, K_P_C9
};



double thermocouple_from_T_to_E(double temp) {
    double e, sum = 0;

    if (temp >= 0) {
        for (int i = 0; i < (sizeof(k_type_p_coeff_inv_table) / sizeof(k_type_p_coeff_inv_table[0])); i++) {
            sum += k_type_p_coeff_inv_table[i] * pow(temp, i);
        }

        e = sum + 0.118597600000 * exp(-0.118343200000E-3 * (temp - 0.126968600000E3)* (temp - 0.126968600000E3));
    } else {
        for (int i = 0; i < (sizeof(k_type_n_coeff_inv_table) / sizeof(k_type_n_coeff_inv_table[0])); i++) {
            sum += k_type_n_coeff_inv_table[i] * pow(temp, i);
        }

        e = sum;
    }

    return e;

}



#define K_N_D0  (0.0000000E+00)
#define K_N_D1  (2.5173462E+01)
#define K_N_D2  (-1.1662878E+00)
#define K_N_D3  (-1.0833638E+00)
#define K_N_D4  (-8.9773540E-01)
#define K_N_D5  (-3.7342377E-01)
#define K_N_D6  (-8.6632643E-02)
#define K_N_D7  (-1.0450598E-02)
#define K_N_D8  (-5.1920577E-04)
#define K_N_D9  (0.0000000E+00)

static const double k_type_n_coeff_table[] = {
    K_N_D0, K_N_D1, K_N_D2, K_N_D3, K_N_D4, K_N_D5, K_N_D6, K_N_D7, K_N_D8, K_N_D9
};


#define K_P_0_500_D0 (0.0000000E+00)
#define K_P_0_500_D1 (2.508355E+01)
#define K_P_0_500_D2 (7.860106E-02)
#define K_P_0_500_D3 (-2.503131E-01)
#define K_P_0_500_D4 (8.315270E-02)
#define K_P_0_500_D5 (-1.228034E-02)
#define K_P_0_500_D6 (9.804036E-04)
#define K_P_0_500_D7 (-4.413030E-05)
#define K_P_0_500_D8 (1.057734E-06)
#define K_P_0_500_D9 (-1.052755E-08)

static const double k_type_p_coeff_table_0_500[] = {
    K_P_0_500_D0, K_P_0_500_D1, K_P_0_500_D2, K_P_0_500_D3, K_P_0_500_D4, K_P_0_500_D5, K_P_0_500_D6, K_P_0_500_D7, K_P_0_500_D8, K_P_0_500_D9
};




double thermocouple_from_E_to_T(double e) {
    double sum = 0;

    if (e < 0) {
        for (int i = 0; i < (sizeof(k_type_n_coeff_table) / sizeof(k_type_n_coeff_table[0])); i++) {
            sum += k_type_n_coeff_table[i] * pow(e, i);
        }
    } else {
        for (int i = 0; i < (sizeof(k_type_p_coeff_table_0_500) / sizeof(k_type_p_coeff_table_0_500[0])); i++) {
            sum += k_type_p_coeff_table_0_500[i] * pow(e, i);
        }
    }


    return sum;
}


bool thermocouple_find_temp(float v, float *temp) {
    uint32_t s = 0, e = THERMOCOUPLE_TAB_SIZE - 1;
    uint32_t m;
    float t;

    if ((v < k_type_thermocouple_table[0]) || (v > k_type_thermocouple_table[THERMOCOUPLE_TAB_SIZE - 1])) {
        return false;
    }

    do {
        m = (s + e) / 2;
        if (v >= k_type_thermocouple_table[m]) {
            s = m;
        } else {
            e = m;
        }
    } while ((e - s) > 1);
    
    if (e == s) {
        *temp = (float)(THERMOCOUPLE_BASE + s);
    } else {
        *temp = THERMOCOUPLE_BASE + s + (v - k_type_thermocouple_table[s]) /  (k_type_thermocouple_table[e] - k_type_thermocouple_table[s]);
    }

    return true;
}







