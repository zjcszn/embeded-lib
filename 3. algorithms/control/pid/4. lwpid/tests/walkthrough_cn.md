# PID 库重构与验证说明

## 概述
我们已成功重构 PID 库，使其满足现代工业标准。改进重点在于可靠性、抗噪性和易用性。

## 主要变更

### 1. 鲁棒微分项 (Robust Derivative)
*   **问题**：原实现计算 `D = Kd * (Error - PrevError) / dt`，当设定值 (Setpoint) 改变时会导致输出剧烈跳变（微分冲击/Derivative Kick）。
*   **解决方案**：默认启用 **“微分先行” (Derivative on Measurement)**：`D = -Kd * (PV - PrevPV) / dt`。这确保了对设定值变更的平滑响应。
*   **增强**：为微分项增加了 **低通滤波器 (LPF)** (`d_lpf_alpha`)，使其对传感器噪声具有鲁棒性。

### 2. 智能抗积分饱和 (Intelligent Anti-Windup)
*   **问题**：简单的限幅仅限制了积分项的绝对值，但无法防止“积分饱和 (Windup)”——即当输出已饱和时积分器仍在累积。
*   **解决方案**：实现了 **条件积分 (Conditional Integration)**。积分器将在以下情况暂停累积：
    *   输出已饱和 (max/min)
    *   **并且** 误差试图驱动输出进一步深陷饱和区。
    这允许系统在误差反转时立即退出饱和区。

### 3. 线性死区 (Linear Deadband)
*   **问题**：原死区逻辑只是简单地将死区内误差置零，导致震荡。
*   **解决方案**：实现了 **线性死区**。如果误差在死区外，有效误差将减去死区宽度，实现平滑过渡。
 
### 4. 增量式 PID (Incremental PID) [新增]
*   **功能**：新增 `pid_update_incremental` 接口，输出控制量变化率 ($\Delta u$)。
*   **应用**：适用于驱动步进电机、电动阀等积分型执行器，或用于无扰切换。
*   **注意**：此模式下 `out_max/out_min` 被解释为 **输出变化率限制** (Max Delta per Step)。

## 验证
我们创建了仿真测试 (`simulation_main.c` 和 `simulation_main_inc.c`) 来验证算法。

### 仿真结果
1.  **位置式 PID**：
    *   **阶跃响应**：平滑无超调，无微分冲击。
    *   **抗扰动**：迅速响应负载变化。
    *   **抗噪声**：微分滤波器有效平滑了噪声。

2.  **增量式 PID**：
    *   通过对比测试，确认增量式实现的输出累积值与位置式 PID 的数学行为一致（差异仅为启动时的初始偏移，属于正常的“无扰启动”特性）。

![PID 测试结果](pid_test_result.png)
*(由 `python test_runner.py` 生成)*
